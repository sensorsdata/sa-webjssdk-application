define(function(){"use strict";var t={sa:{},info:{},lib_version:"0.4.0",defaultPara:{platform:"H5"},serverData:{},localData:{global_popup_count:[],local_update_time:null,eventQueue:[]},eventRule:{},convertPlans:[],isRun:!1,setArg:function(t){var e={};if(t&&"[object Object]"===Object.prototype.toString.call(t)){for(var n in t)n&&"popup_window_content"!==n&&(e[n]=t[n]);return JSON.stringify(e,null,"  ")}return t},log:function(){if(t.info.show_log===!0&&"object"==typeof console&&"function"==typeof console.log)try{return arguments[0]=t.setArg(arguments[0]),arguments[1]=t.setArg(arguments[1]),console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}}};t.config={storageName:"sensorsdata202002-webpopupdata",loadedSign:"SensorsData2015JSSDKWebPopupIsLoad"};var e={visibility:function(t){t=t||{};var e={hidden:void 0,visibilityChange:void 0,isSupported:function(){return"undefined"!=typeof this.hidden},_visible:t.onVisible,_hidden:t.onHidden,_nativeSwitch:function(){document[this.hidden]===!0?this._hidden():this._visible()},listen:function(){try{this.isSupported()?document.addEventListener(this.visibilityChange,function(){e._nativeSwitch.apply(e,arguments)},1):document.addEventListener?(window.addEventListener("focus",this._visible,1),window.addEventListener("blur",this._hidden,1)):(document.attachEvent("onfocusin",this._visible),document.attachEvent("onfocusout",this._hidden))}catch(t){}},init:function(){"undefined"!=typeof document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(this.hidden="mozHidden",this.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(this.hidden="msHidden",this.visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"),this.listen()}};e.init()},getRgba:function(t){return"object"!=typeof t?t:"rgba("+t.r+","+t.g+","+t.b+","+t.a+")"},conversionNum:function(t){if(t){if(/^[0|1]?\.\d+$/.test(t))return 100*Number(t)+"%";var e=/^(-?\d+(\.\d+)?)px$/.exec(t);return e?(Number(e[1])/375*window.screen.width).toFixed(2)+"px":t}},boxModel:function(t){return function(n){if("object"!=typeof n)return t+":"+n+";";var i="";for(var o in n)i+=t+"-"+o+":"+e.conversionNum(n[o])+";";return i}},localStorage:{get:function(t){return window.localStorage.getItem(t)},parse:function(t){var n=null;try{n=JSON.parse(e.localStorage.get(t))||null}catch(i){}return n},set:function(t,e){window.localStorage.setItem(t,e)},remove:function(t){window.localStorage.removeItem(t)},isSupport:function(){var t=!0;try{var n="__sensorsdatasupport__",i="testIsSupportStorage";e.localStorage.set(n,i),e.localStorage.get(n)!==i&&(t=!1),e.localStorage.remove(n)}catch(o){t=!1}return t}},addEvent:function(){function t(e){return e&&(e.preventDefault=t.preventDefault,e.stopPropagation=t.stopPropagation,e._getPath=t._getPath),e}function e(e,n,i){var o=function(o){if(o=o||t(window.event)){o.target=o.srcElement;var a,r,s=!0;return"function"==typeof i&&(a=i(o)),r=n.call(e,o),!1!==a&&!1!==r||(s=!1),s}};return o}t._getPath=function(){var t=this,e=function(){try{var e=t.target,n=[e];if(null===e||null===e.parentElement)return[];for(;null!==e.parentElement;)e=e.parentElement,n.unshift(e);return n}catch(i){return[]}};return this.path||this.composedPath&&this.composedPath()||e()},t.preventDefault=function(){this.returnValue=!1},t.stopPropagation=function(){this.cancelBubble=!0};var n=function(n,i,o){if(n&&n.addEventListener)n.addEventListener(i,function(e){e._getPath=t._getPath,o.call(this,e)},!1);else{var a="on"+i,r=n[a];n[a]=e(n,o,r)}};n.apply(null,arguments)},extend:function(t){var n=Array.prototype.slice;return e.each(n.call(arguments,1),function(e){for(var n in e)void 0!==e[n]&&(t[n]=e[n])}),t},extend2Lev:function(t){return e.each(Array.prototype.slice.call(arguments,1),function(n){for(var i in n)void 0!==n[i]&&(e.isObject(n[i])&&e.isObject(t[i])?e.extend(t[i],n[i]):t[i]=n[i])}),t},each:function(t,e,n){var i=Object.prototype.hasOwnProperty,o=Array.prototype.forEach,a={};if(null==t)return!1;if(o&&t.forEach===o)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,s=t.length;r<s;r++)if(r in t&&e.call(n,t[r],r,t)===a)return!1}else for(var u in t)if(i.call(t,u)&&e.call(n,t[u],u,t)===a)return!1},xhr:function(t){if(t)return"undefined"!=typeof window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?new XMLHttpRequest:"undefined"!=typeof XDomainRequest?new XDomainRequest:null;if("undefined"!=typeof window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},ajax:function(t){function n(t){if(!t)return"";try{return JSON.parse(t)}catch(e){return{}}}function i(){try{e.isObject(o)&&o.abort&&o.abort()}catch(n){sd.log(n)}a&&(clearTimeout(a),a=null,t.error&&t.error(),o.onreadystatechange=null,o.onload=null,o.onerror=null)}t.timeout=t.timeout||2e4,t.credentials="undefined"==typeof t.credentials||t.credentials;var o=e.xhr(t.cors);if(!o)return!1;t.type||(t.type=t.data?"POST":"GET"),t=e.extend({success:function(){},error:function(){}},t);var a,r=t.success,s=t.error;t.success=function(t){r(t),a&&(clearTimeout(a),a=null)},t.error=function(t){s(t),a&&(clearTimeout(a),a=null)},a=setTimeout(function(){i()},t.timeout),"undefined"!=typeof XDomainRequest&&o instanceof XDomainRequest&&(o.onload=function(){t.success&&t.success(n(o.responseText)),o.onreadystatechange=null,o.onload=null,o.onerror=null},o.onerror=function(){t.error&&t.error(n(o.responseText),o.status),o.onreadystatechange=null,o.onerror=null,o.onload=null}),o.onreadystatechange=function(){try{4==o.readyState&&(o.status>=200&&o.status<300||304==o.status?t.success(n(o.responseText)):t.error(n(o.responseText),o.status),o.onreadystatechange=null,o.onload=null)}catch(e){o.onreadystatechange=null,o.onload=null}},o.open(t.type,t.url,!0);try{t.credentials&&(o.withCredentials=!0),e.isObject(t.header)&&e.each(t.header,function(t,e){o.setRequestHeader&&o.setRequestHeader(e,t)}),t.data&&(t.cors||o.setRequestHeader&&o.setRequestHeader("X-Requested-With","XMLHttpRequest"),"application/json"===t.contentType?o.setRequestHeader&&o.setRequestHeader("Content-type","application/json; charset=UTF-8"):o.setRequestHeader&&o.setRequestHeader("Content-type","application/x-www-form-urlencoded"))}catch(u){sd.log(u)}o.send(t.data||null)},getUuid:function(){var t=function(){for(var t=1*new Date,e=0;t==1*new Date;)e++;return t.toString(16)+e.toString(16)},e=function(){return Math.random().toString(16).replace(".","")};return function(){var n=t()+"-"+e()+"-"+e();return n?n:(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15)}},trim:function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},isEmptyObject:function(t){var n=Object.prototype.hasOwnProperty;if(e.isObject(t)){for(var i in t)if(n.call(t,i))return!1;return!0}return!1},filter:function(t,e,n){var i=Object.prototype.hasOwnProperty;if(t.filter)return t.filter(e);for(var o=[],a=0;a<t.length;a++)if(i.call(t,a)){var r=t[a];e.call(n,r,a,t)&&o.push(r)}return o},isObject:function(t){return null!=t&&"[object Object]"==Object.prototype.toString.call(t)},getConvertNumberValue:function(t){return e.isString(t)&&(t=Number(t)),Math.floor(1e3*t)/1e3},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"==Object.prototype.toString.call(t)},isDate:function(t){return"[object Date]"==Object.prototype.toString.call(t)},isBoolean:function(t){return"[object Boolean]"==Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"==Object.prototype.toString.call(t)&&/[\d\.]+/.test(String(t))},isFunction:function(t){if(!t)return!1;try{return/^\s*\bfunction\b/.test(t)}catch(e){return!1}},getURLSearchParams:function(t){t=t||"";for(var e=function(t){return decodeURIComponent(t)},n={},i=t.substring(1),o=i.split("&"),a=0;a<o.length;a++){var r=o[a].indexOf("=");if(r!==-1){var s=o[a].substring(0,r),u=o[a].substring(r+1);s=e(s),u=e(u),n[s]=u}}return n},URL:function(t){var n={},i=["hash","host","hostname","href","origin","password","pathname","port","protocol","search","username"],o=function(){var t;try{return t=new URL("http://modernizr.com/"),"http://modernizr.com/"===t.href}catch(e){return!1}};if("function"==typeof window.URL&&o())n=new URL(t),n.searchParams||(n.searchParams=function(){var t=e.getURLSearchParams(n.search);return{get:function(e){return t[e]}}}());else{var a=/^https?:\/\/.+/;if(a.test(t)===!1)throw"Invalid URL";var r=document.createElement("a");r.href=t;for(var s=i.length-1;s>=0;s--){var u=i[s];n[u]=r[u]}n.hostname&&"string"==typeof n.pathname&&0!==n.pathname.indexOf("/")&&(n.pathname="/"+n.pathname),n.searchParams=function(){var t=e.getURLSearchParams(n.search);return{get:function(e){return t[e]}}}()}return n},contentLoaded:function(t,e){var n=!1,i=!0,o=t.document,a=o.documentElement,r=o.addEventListener,s=r?"addEventListener":"attachEvent",u=r?"removeEventListener":"detachEvent",l=r?"":"on",p=function(i){"readystatechange"==i.type&&"complete"!=o.readyState||(("load"==i.type?t:o)[u](l+i.type,p,!1),!n&&(n=!0)&&e.call(t,i.type||i))},c=function(){try{a.doScroll("left")}catch(t){return void setTimeout(c,50)}p("poll")};if("complete"==o.readyState)e.call(t,"lazy");else{if(!r&&a.doScroll){try{i=!t.frameElement}catch(_){}i&&c()}o[s](l+"DOMContentLoaded",p,!1),o[s](l+"readystatechange",p,!1),t[s](l+"load",p,!1)}}};t._=e,t.isSupportPopup=function(){return e.localStorage.isSupport()},t.listenPageStateChange=function(){var n=!0;e.visibility({onVisible:function(){t.log("\u9875\u9762\u89e6\u53d1visible-",(new Date).getMinutes(),"\u5206",(new Date).getSeconds()),n===!1&&(t.updateDataAndSetListen.startState(),n=!0)},onHidden:function(){t.log("\u9875\u9762\u89e6\u53d1hidden-",(new Date).getMinutes(),"\u5206",(new Date).getSeconds()),n===!0&&(t.updateDataAndSetListen.stopAllState(),n=!1)}})},t.getWebSDK=function(){return!!(e.isObject(window.sensorsDataAnalytic201505)&&e.isObject(window.sensorsDataAnalytic201505.readyState)&&window.sensorsDataAnalytic201505.readyState.state>=3)&&window.sensorsDataAnalytic201505},t.getPopupInfo=function(t){function n(t){e.each(t.subviews,function(t){var e=t.properties||{};"title"===e.msgType?i.$sf_msg_title=e.text:"content"===e.msgType?i.$sf_msg_content=e.text:"image"===t.type&&(i.$sf_msg_image_url=e.image),t.subviews&&n(t)})}if(!e.isObject(t)||!e.isObject(t.template))return{};var i={$sf_msg_title:"",$sf_msg_content:"",$sf_msg_image_url:""};return n(t.template),i},t.getSFCampaign=function(t){t=e.isObject(t)?t:{};var n={planId:"",name:"",content:null,type:""};return n.planId=t.plan_id||"",n.name=t.cname||"",n.content=e.isObject(t.popup_window_content)?t.popup_window_content.content:"",n.type=e.isObject(t.popup_window_content)&&t.popup_window_content.popup_type?t.popup_window_content.popup_type:"PRESET",n},t.getImageList=function(t){if(!e.isArray(t))return!1;for(var n,i,o=new RegExp('("(backgroundImage|image)":"(http(s)?://.[^"]*)")',"g"),a=new RegExp('http(s)?://.[^S^"]*'),r={},s=t.length,u=[],l=0;l<s;l++)if("ACTIVE"===t[l].status.toLocaleUpperCase()&&t[l].is_trigger!==!1&&(t[l].popup_window_content&&t[l].popup_window_content.content&&(n=t[l].popup_window_content.content.match(o)),n))for(var p=0,c=n.length;p<c;p++)i=n[p].match(a),i&&i.length>0&&(r[i[0]]||(r[i[0]]=1));return e.each(r,function(t,e){u.push(e)}),u},t.setIsLoad=function(){var e=window.self===window.top;if(e){if(window[t.config.loadedSign])return!1;if("undefined"==typeof window[t.config.loadedSign])return window[t.config.loadedSign]=!0,!0}else try{return!window.top[t.config.loadedSign]&&(window.top[t.config.loadedSign]=!0,!0)}catch(n){return t.log("\u975e\u540c\u57df\u540diframe\u5185\u5d4c\u4e0d\u80fd\u83b7\u53d6\u7236\u7ea7\u7a97\u4f53\u5185\u5bb9",n),!0}},t.handlerCampaign=function(n){var i=n,o=e.getUuid()(),a=i.plan.popup_window_content;if(!e.isObject(a))return i.popupFailed(1001,!1,{uuid:o,content:"",plan:i.plan}),!1;var r;if(a.content)try{r=JSON.parse(a.content)}catch(s){t.log(s)}var u=t.getSFCampaign(i.plan),l={state:"",isCustom:!1},p=!0;try{p=t.info.popup_campaign_listener.shouldStart(u)}catch(s){p=!1,t.log(s)}var c={uuid:o,content:r,plan:i.plan};switch(i.plan.is_trigger?p?"CUSTOMIZED"===a.popup_type?"withoutCampaignListener"===t.info.supportCustom?l.state="CAMPAIGN_CUSTOMIZED_NULL_LISTENER":"withoutStart"===t.info.supportCustom?l.state="CAMPAIGN_CUSTOMIZED_LISTENER_NULL_START":e.isString(a.content)?l.state="CAMPAIGN_TRIGGER_CUSTOMIZED_START":l.state="DIALOG_NOT_SHOW_JSON_FAILED":("PRESET"===a.popup_type&&t.log("\u6b64\u7248\u672csdk\u4e0d\u652f\u6301\u9884\u7f6e\u5f39\u7a97"),l.state="DIALOG_NOT_SHOW_JSON_FAILED"):l.state="CAMPAIGN_NOT_START_LISTENER_START":l.state="CAMPAIGN_NOT_START_TRIGGER",l.isCustom=!(!a.popup_type||"CUSTOMIZED"!==a.popup_type),t.log("campaign:",l,"plan:",i.plan.cname),l.state){case"CAMPAIGN_TRIGGER_CUSTOMIZED_START":i.customCampaign(c);break;case"CAMPAIGN_NOT_START_LISTENER_START":i.popupFailed(1004,l.isCustom,c);break;case"CAMPAIGN_CUSTOMIZED_NULL_LISTENER":i.popupFailed(1006,l.isCustom,c);break;case"CAMPAIGN_CUSTOMIZED_LISTENER_NULL_START":i.popupFailed(1006,l.isCustom,c);break;case"DIALOG_NOT_SHOW_JSON_FAILED":i.popupFailed(1001,l.isCustom,c);break;case"CAMPAIGN_NOT_START_TRIGGER":i.popupFailed(1005,l.isCustom,c);break;default:t.log("CampaignState\u5f02\u5e38")}},t.track={getPublicProps:function(n){var i=n.plan,o={$sf_lib_version:t.lib_version,$sf_plan_type:"\u8fd0\u8425\u8ba1\u5212",$sf_channel_service_name:"SENSORS_FOCUS",$sf_channel_category:"POPUP",$sf_platform_tag:t.info.platform,$sf_msg_id:n.$sf_msg_id};return e.isEmptyObject(i)||!e.isObject(i)?o:(o.$sf_plan_id=i.plan_id+"",o.$sf_plan_strategy_id=i.strategy_id?i.strategy_id:i.is_control_group?"-1":"0",i.audience_id&&(o.$sf_audience_id=i.audience_id+""),o)},popupDisplay:function(t){var e={$sf_msg_title:t.$sf_msg_title,$sf_msg_content:t.$sf_msg_content,$sf_msg_image_url:t.$sf_msg_image_url,$sf_succeed:t.$sf_succeed,$sf_fail_reason:t.$sf_fail_reason};this.trackEvent("$PlanPopupDisplay",e,t)},trackEvent:function(n,i,o){var a=t.track.getPublicProps(o);e.extend(i,a),e.each(i,function(t,e){""!==t&&void 0!==t||delete i[e]}),t.sa.track(n,i)},maskClick:function(t){if(!t.msg)return!1;var e={$sf_close_type:"POPUP_CLOSE_MASK",$sf_msg_title:t.msg.$sf_msg_title,$sf_msg_content:t.msg.$sf_msg_content,$sf_msg_image_url:t.msg.$sf_msg_image_url,$sf_msg_element_type:"mask",$sf_msg_action_id:t.properties.maskActionId};this.trackEvent("$PlanPopupClick",e,t.msg),t.destory()},elementClickCallback:function(n,i){var o=n.target,a=o.getAttribute("data-action"),r=o.getAttribute("data-info"),s=i.msg||{};if(!a)return!1;try{var u=JSON.parse(a)||{},l=u[0],p=JSON.parse(r)||{}}catch(n){t.log("elementClickCallback error",n)}var c={type:l.type,value:e.isString(l.value)?l.value:"",extra:e.isObject(l.value)?l.value:""},_=i.msg.plan?i.msg.plan.plan_id:"",d={$sf_msg_title:s.$sf_msg_title,$sf_msg_content:s.$sf_msg_content,$sf_msg_image_url:s.$sf_msg_image_url,$sf_msg_element_type:p.$sf_msg_element_type,$sf_msg_element_content:p.$sf_msg_element_content,$sf_msg_element_action:l.type,$sf_msg_action_id:l.id,$sf_close_type:"close"===l.type?l.$sf_close_type:""};this.trackEvent("$PlanPopupClick",d,s);try{t.info.popup_listener.onClick(_,c)}catch(n){t.log("popup_listener.onClick error",n)}if("close"===l.type)i.destory();else if(l.closeable?i.destory():null,"auto"===t.info.popup_listener.openlink&&"openlink"===l.type){if("http"!==l.value.slice(0,4))return!1;window.location.href=l.value}}};var n=t.log;return t.changeCovertStatus=function(n){var i=JSON.parse(JSON.stringify(t.convertPlans));e.each(i,function(i,o){if(!i.is_in_convert_window)return!1;var a=i.is_in_convert_window.step,r=i.is_in_convert_window.uuid;return t.convertPlans[o].is_in_convert_window.step=Math.min(2*a,6e5),!!n&&void e.each(n,function(e){e.popup_display_uuid===r&&e.convert_time&&(delete t.convertPlans[o].is_in_convert_window,t.convertPlans.splice(o,1))})})},t.asyncConvert=function(n){function i(){if(e.isEmptyObject(t.localData)||!e.isArray(t.convertPlans)||0===t.convertPlans.length)return!1;var n=JSON.parse(JSON.stringify(t.convertPlans)),a=n[0].is_in_convert_window&&n[0].is_in_convert_window.step||5e3,r=[];return e.each(n,function(e,n){if(!e.is_in_convert_window)return!1;var i=(new Date).getTime(),o=e.is_in_convert_window.expire_time;return i>o?(delete t.convertPlans[n].is_in_convert_window,t.convertPlans.splice(n,1),!1):(r.push(e.is_in_convert_window.uuid),e.is_in_convert_window.step||(e.is_in_convert_window.step=5e3,t.convertPlans[n].is_in_convert_window.step=5e3),void(a>e.is_in_convert_window.step&&(a=e.is_in_convert_window.step)))}),!!r.length&&(t.asyncConvert.timer&&clearTimeout(t.asyncConvert.timer),void(t.asyncConvert.timer=setTimeout(function(){e.ajax({url:t.info.api_base_url+"/sfo/popup_displays?project="+encodeURIComponent(o)+"&popup_display_uuids="+encodeURIComponent(r)+"&time="+(new Date).getTime(),type:"GET",cors:!0,credentials:!1,contentType:"application/json",success:function(e){t.changeCovertStatus(e),i()},error:function(){t.changeCovertStatus(),i()}})},a)))}var o=t.info.project,a=!1;return!(!n&&0===t.convertPlans.length)&&(n&&(e.each(t.convertPlans,function(t){t.plan_id===n.plan_id&&(a=!0)}),a||t.convertPlans.push(n)),void i())},t.ruleTime={getExpire:function(t,e){var n=e,i=Number(t.value)||0,o=Number(t.value)||0,a=String(t.unit).toLowerCase(),r=null,s={day:function(){return r=new Date(n),r.setHours(23),r.setMinutes(59),r.setSeconds(59),r.setMilliseconds(999),r=r.getTime()+864e5*(o-1)},week:function(){r=new Date(n);var t=r.getDay();0===t&&(t=7);var e=7-t;return r.setHours(23),r.setMinutes(59),r.setSeconds(59),r.setMilliseconds(999),r=r.getTime()+24*e*60*60*1e3+7*(o-1)*24*60*60*1e3},month:function(){r=new Date(n);var t=r.getMonth(),e=t+o;return e>=11?(r.setFullYear(r.getFullYear()+parseInt(e/12)),r.setMonth(e%12)):r.setMonth(e),r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),r.getTime()},second:function(t){var e={month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},o=null;return r=new Date(n),t in e&&(o=e[t]*i),r.getTime()+o}};return t.natural!==!0?s.second(a):a in s?s[a]():void 0},getLast:function(t,e){var n=Number(t.value)||0,i=Number(t.value)-1||0,o=String(t.unit).toLowerCase(),a=null,r={day:function(){return a=new Date(e),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a=a.getTime()-864e5*i},week:function(){a=new Date(e);var t=a.getDay();return 0===t&&(t=7),--t,a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a=a.getTime()-(24*t*60*60*1e3+7*i*24*60*60*1e3)},month:function(){a=new Date(e);var t=a.getMonth()+1,n=t-i;return n<=0?(a.setFullYear(a.getFullYear()+(parseInt(n/12)-1)),a.setMonth(12+n%12-1)):a.setMonth(n-1),a.setDate(1),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.getTime()},second:function(t){var i={month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},o=null;return a=new Date(e),t in i&&(o=i[t]*n),a.getTime()-o}};return t.natural!==!0?r.second(o):o in r?r[o]():void 0},getArrMatchCount:function(t,e){var n=0;for(n=0;n<t.length;n++)if(e>=t[n])return n;return t.length}},t.eventTriggerProcess=function(){if(!t.updateDataAndSetListen.active_state)return!1;if(!e.isArray(t.localData.eventQueue))return!1;if(0===t.localData.eventQueue.length)return!1;if(t.isRun)return!1;n("\u4e8b\u4ef6\u961f\u5217---eventQueue",t.localData.eventQueue);var i=!1,o=t.localData.eventQueue[0],a=t.eventRule[o.event];t.isRun=!0,t.localData.eventQueue.shift(),e.isArray(a)&&e.isObject(a[0])&&a.length>0&&(n("--------------------\u89e6\u53d1\u4e8b\u4ef6\u5f00\u59cb--------------------"),e.each(a,function(n){e.isObject(n)&&"undefined"!=typeof n.match_state&&delete n.match_state,new t.RuleCheck(n,o)}),e.each(a,function(e){e.match_state===!0?i===!1?(i=!0,n("\u68c0\u67e5\u5b8c\u6bd5-\u4f18\u5148\u5f39\u7a97-\u5f00\u59cb",e.plan.cname),new t.PopupCheck(e,(!0))):i===!0&&(n("\u68c0\u67e5\u5b8c\u6bd5-\u975e\u4f18\u5148\u5f39\u7a97-\u4e0d\u6e32\u67d3",e.plan.cname),new t.PopupCheck(e,(!1))):n("\u68c0\u67e5\u5b8c\u6bd5-\u8ba1\u5212-\u4e0d\u6ee1\u8db3",e.plan.cname)}),i||t.completeWindowLifecycle(),n("--------------------\u89e6\u53d1\u4e8b\u4ef6\u7ed3\u675f--------------------"))},t.completeWindowLifecycle=function(){t.isRun=!1,t.eventTriggerProcess()},t.PopupCheck=function(t,e){this.plan=t.plan,this.current_time=(new Date).getTime(),e?this.renderPopup():this.hidePopup()},t.PopupCheck.prototype.createPopupWindow=function(e,n){this.startConvertWindow(e),this.startPopupIntervalWindow(this.current_time),this.startPopupLimitWindow(),this.setGlobalLimit(),this.deletePlanAllWindow(),n&&t.completeWindowLifecycle()},t.PopupCheck.prototype.hidePopup=function(){this.deletePlanAllWindow()},t.PopupCheck.prototype.renderPopup=function(){t.handlerCampaign(this)},t.PopupCheck.prototype.popupFailed=function(n,i,o){var a={1001:"\u9884\u89c8\u4fe1\u606f\u89e3\u6790\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u8ba1\u5212\u914d\u7f6e",1003:"\u5bf9\u7167\u7ec4",1004:"campaignShouldStart \u63a5\u53e3\u8fd4\u56de false",1005:"\u8ba1\u5212\u4e0b\u53d1 is_trigger \u4e3a false",1006:"\u81ea\u5b9a\u4e49\u89e6\u8fbe\u8ba1\u5212\u672a\u5b9e\u73b0\u5f39\u7a97\u751f\u547d\u5468\u671f\u56de\u8c03"},r=a[n],s=t.getPopupInfo(o.content);s.$sf_msg_id=o.uuid,s.plan=o.plan,s.$sf_succeed=!1,s.$sf_fail_reason=r,t.track.popupDisplay(s),!i&&t.info.popup_listener&&e.isFunction(t.info.popup_listener.onLoadFailed)&&t.info.popup_listener.onLoadFailed(o.plan.plan_id,n,r),t.info.popup_campaign_listener.onFailed(t.getSFCampaign(o.plan),n,r),this.createPopupWindow(o.uuid,!0)},t.PopupCheck.prototype.customCampaign=function(e){var n=t.getSFCampaign(e.plan),i=t.getPopupInfo(e.content);i.$sf_msg_id=e.uuid,i.plan=e.plan,i.$sf_succeed=!0,t.track.popupDisplay(i),t.info.popup_campaign_listener.onStart(n),this.createPopupWindow(e.uuid,!0)},t.PopupCheck.prototype.showPopup=function(i){if(!t.ElementRender)return t.log("\u6682\u4e0d\u652f\u6301\u9884\u7f6e\u5f39\u7a97UI"),!1;var o=new t.ElementRender(i.content),a=t.getPopupInfo(i.content);a.$sf_msg_id=i.uuid,a.plan=i.plan,a.$sf_succeed=!0,e.extend(o.msg,a),o.popupCheckInstance=this,t.track.popupDisplay(a);var r=o.render();return r?(t.info.popup_campaign_listener.onStart(t.getSFCampaign(i.plan)),this.createPopupWindow(i.uuid),void t.info.popup_listener.onLoadSuccess(i.plan.plan_id)):(n("\u5f53\u524d\u9875\u9762\u5df2\u6709\u4e00\u4e2a\u5f39\u6846\u6b63\u5728\u6e32\u67d3\uff0c\u672c\u6b21\u5f39\u6846\u4e0d\u6e32\u67d3\uff01"),!1)},t.PopupCheck.prototype.startConvertWindow=function(i){n("--\u5f39\u7a97\u5c55\u793a-\u8f6c\u5316\u7a97\u53e3\u8bbe\u7f6e",this.plan.cname),e.isObject(this.plan.convert_window)&&this.plan.convert_window.value&&(this.plan.is_in_convert_window={expire_time:t.ruleTime.getExpire(this.plan.convert_window,this.current_time),start_time:this.current_time,uuid:i},t.asyncConvert(this.plan))},t.PopupCheck.prototype.startPopupIntervalWindow=function(n){e.isObject(this.plan.popup_interval)&&this.plan.popup_interval.value&&(this.plan.is_in_popup_interval_window=t.ruleTime.getExpire(this.plan.popup_interval,n))},t.PopupCheck.prototype.resetPopupIntervalWindow=function(){var e=(new Date).getTime();this.startPopupIntervalWindow(e),this.resetGlobalLimit(e),t.completeWindowLifecycle()},t.PopupCheck.prototype.startPopupLimitWindow=function(){n("--\u5f39\u7a97\u5c55\u793a-\u53c2\u4e0e\u9650\u5236\u7a97\u53e3\u8bbe\u7f6e\u91cd\u7f6e"),e.isObject(this.plan.re_enter)&&this.plan.re_enter.value&&(e.isObject(this.plan.is_in_popup_limit_window)?this.plan.is_in_popup_limit_window.count++:this.plan.is_in_popup_limit_window={expire_time:t.ruleTime.getExpire(this.plan.re_enter,this.current_time),count:1})},t.PopupCheck.prototype.setGlobalLimit=function(){n("--\u5f39\u7a97\u5c55\u793a-\u5168\u5c40\u5f39\u7a97\u6b21\u6570\u8bbe\u7f6e"),e.isArray(t.localData.global_popup_count)||(t.localData.global_popup_count=[]),t.localData.global_popup_count.unshift(this.current_time);for(var i=t.localData.global_popup_count,o=i[i.length-1];o+7776e6<this.current_time||i.length>3e3;)i.pop(),o=i[i.length-1]},t.PopupCheck.prototype.resetGlobalLimit=function(n){e.isArray(t.localData.global_popup_count)&&t.localData.global_popup_count.length>0&&(t.localData.global_popup_count.shift(),t.localData.global_popup_count.unshift(n))},t.PopupCheck.prototype.deletePlanAllWindow=function(){var t=this.plan.pattern_popup.matcher_list;e.isArray(t)&&e.each(t,function(t){t.is_in_window&&(n("--\u5f39\u7a97\u5c55\u793a-\u91cd\u7f6e\u5404\u4e2a\u89c4\u5219\u7684\u7a97\u53e3\u8ba1\u7b97-\u6210\u529f"),delete t.is_in_window)})},t.RuleCheck=function(t,i){this.plan_match=t,this.plan=t.plan,this.rule_arr=t.rule,this.event_data=i,this.current_time=(new Date).getTime();var o="-------------\u68c0\u67e5-\u8ba1\u5212-("+this.plan.cname+")";e.each(this.rule_arr,function(t){o+="--\u5305\u542b\u89c4\u5219-("+t.event_name+"\uff09-\u89e6\u53d1"+t.params[0]+"\u6b21"}),n(o),n(this.plan),this.checkPlanIsExpire()},t.RuleCheck.prototype.checkPlanIsExpire=function(){!this.plan.expire_at||e.isNumber(this.plan.expire_at)&&this.current_time<this.plan.expire_at?(n("--\u8fc7\u671f-\u6ee1\u8db3",this.plan.cname),this.checkPlanIsAudience()):n("--\u8fc7\u671f-\u4e0d\u6ee1\u8db3",this.plan.cname)},t.RuleCheck.prototype.checkPlanIsAudience=function(){this.plan.is_audience===!0?(n("--\u662f\u5426\u53d7\u4f17-\u6ee1\u8db3",this.plan.cname),this.checkPlanSuspend()):n("--\u662f\u5426\u53d7\u4f17-\u4e0d\u6ee1\u8db3",this.plan.cname)},t.RuleCheck.prototype.checkPlanSuspend=function(){this.plan.status&&"SUSPEND"===this.plan.status?n("--\u6682\u505c-\u4e0d\u6ee1\u8db3",this.plan.cname):(n("--\u6682\u505c-\u6ee1\u8db3",this.plan.cname),this.checkConvert())},t.RuleCheck.prototype.checkConvert=function(){if(e.isObject(this.plan.is_in_convert_window)&&this.plan.is_in_convert_window.expire_time>this.current_time)n("--\u5b58\u5728\u8f6c\u5316\u7a97\u53e3 - \u4e0d\u6ee1\u8db3",this.plan.is_in_convert_window);else if(e.isObject(this.plan.is_in_convert_window)&&this.current_time>this.plan.is_in_convert_window.expire_time){n("--\u8f6c\u5316\u7a97\u53e3\u8d85\u65f6\u5df2\u7ecf\u8fc7\u671f - \u6ee1\u8db3",this.plan.is_in_convert_window),delete this.plan.is_in_convert_window;for(var i=0;i<t.convertPlans.length;i++)this.plan.plan_id===t.convertPlans[i].plan_id&&(t.convertPlans.splice(i,1),i--);this.checkGlobalPopupInterval()}else n("--\u4e0d\u5b58\u5728\u8f6c\u5316\u7a97\u53e3 - \u6ee1\u8db3",this.plan.is_in_convert_window),this.checkGlobalPopupInterval()},t.RuleCheck.prototype.checkGlobalPopupInterval=function(){var i=t.localData.global_popup_count;if(e.isArray(i)&&i.length>=1){var o=t.ruleTime.getLast(t.localData.popup_interval_global,this.current_time);o>i[0]?(n("--\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u6ee1\u8db3-"+o+">\u4e0a\u6b21\u5f39\u7a97\u65f6\u95f4"+i[0]),this.checkPopupInterval()):n("\u68c0\u67e5-\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u4e0d\u6ee1\u8db3-"+o+"<\u4e0a\u6b21\u5f39\u7a97\u65f6\u95f4"+i[0])}else n("--\u5168\u5c40\u5f39\u7a97\u95f4\u9694-\u6ca1\u6709\u5f39\u8fc7\u7a97-\u6ee1\u8db3"),this.checkPopupInterval()},t.RuleCheck.prototype.checkPopupInterval=function(){e.isNumber(this.plan.is_in_popup_interval_window)?this.current_time>this.plan.is_in_popup_interval_window?(n("--\u5f39\u7a97\u95f4\u9694-\u5f53\u524d\u65f6\u95f4\u5927\u4e8e\u56fa\u5b9a\u5f39\u7a97\u95f4\u9694-\u6ee1\u8db3"),this.plan.is_in_popup_interval_window=null,this.checkProperties()):n("--\u5f39\u7a97\u95f4\u9694-\u5f53\u524d\u65f6\u95f4\u5c0f\u4e8e\u56fa\u5b9a\u5f39\u7a97\u95f4\u9694-\u4e0d\u6ee1\u8db3"):(n("--\u5f39\u7a97\u95f4\u9694-\u7a97\u53e3\u4e0d\u5b58\u5728-\u65b0\u5f00"),this.plan.is_in_popup_interval_window=null,this.checkProperties())},t.RuleCheck.prototype.checkProperties=function(){var t={equal:function(t,n){if(!e.isNumber(t)&&!e.isString(t))return!1;for(var i=0,o=n.length;i<o;i++){if(!e.isNumber(n[i])&&!e.isString(n[i]))return!1;if(e.isString(t)){var a=e.isString(n[i])?n[i]:String(n[i]);if(t===a)return!0}else if(e.getConvertNumberValue(t)===e.getConvertNumberValue(n[i]))return!0}return!1},notEqual:function(t,n){if(!e.isNumber(t)&&!e.isString(t))return!1;for(var i=0,o=n.length;i<o;i++){if(!e.isNumber(n[i])&&!e.isString(n[i]))return!1;if(e.isString(t)){var a=e.isString(n[i])?n[i]:String(n[i]);if(t===a)return!1}else if(e.getConvertNumberValue(t)===e.getConvertNumberValue(n[i]))return!1}return!0},contain:function(t,n){return!!e.isString(t)&&t.indexOf(n[0])>=0},notContain:function(t,n){return!!e.isString(t)&&t.indexOf(n[0])===-1},isTrue:function(t){return t===!0},isFalse:function(t){return t===!1},isSet:function(t){return"undefined"!=typeof t},notSet:function(t){return"undefined"==typeof t},isEmpty:function(t){if(!e.isString(t)&&!e.isArray(t))return!1;if(e.isString(t))return""===t;for(var n=0;n<t.length;n++){var i=t[n].replace(/^\s+|\s+$/g,"");if(""!==i)return!1}return!0},isNotEmpty:function(t){if(!e.isString(t)&&!e.isArray(t))return!1;if(e.isString(t))return""!==t;for(var n=0;n<t.length;n++){var i=t[n].replace(/^\s+|\s+$/g,"");if(""===i)return!1}return!0},less:function(t,n){return!!e.isNumber(t)&&("undefined"!=typeof n[0]&&e.getConvertNumberValue(t)<e.getConvertNumberValue(n[0]))},greater:function(t,n){return!!e.isNumber(t)&&("undefined"!=typeof n[0]&&e.getConvertNumberValue(t)>e.getConvertNumberValue(n[0]))},between:function(t,n){if(!e.isNumber(t))return!1;if("undefined"==typeof n[0]&&"undefined"==typeof n[1])return!1;var i=e.getConvertNumberValue(t),o=e.getConvertNumberValue(n[0]),a=e.getConvertNumberValue(n[1]);return i>=o&&i<=a},isIn:function(t,n){if(!e.isArray(t))return!1;for(var i=0;i<t.length;i++)if(n.indexOf(t[i])>=0)return!0;return!1},notInclude:function(t,n){if(!e.isArray(t))return!1;for(var i=0;i<t.length;i++)if(n.indexOf(t[i])===-1)return!0;return!1},absolute_between:function(t,e){try{var i=new Date(e[0]),o=new Date(e[1]),a=new Date(t);return a>=i&&a<=o}catch(r){n("absolute_between Error",r)}},absoluteBetween:function(t,e){try{var i=new Date(e[0]),o=new Date(e[1]),a=new Date(t);return a>=i&&a<=o}catch(r){n("absolute_between Error",r)}}},i=this,o=e.filter(this.rule_arr,function(n){if(!n.filter||n.filter.conditions&&0===n.filter.conditions.length)return!0;var o=n.filter,a=o.relation,r="or"===String(a).toLowerCase(),s="and"===String(a).toLowerCase(),u=!!s,l=!0;return e.each(o.conditions,function(e){if(!l)return!1;if(!e.field)return!1;var n=e.field.lastIndexOf("."),o=e.params,a="in"===e["function"]?isIn:e["function"];if(!t[a])return u=!1,l=!1,!1;if(n<0)return!1;var p=e.field.slice(n+1),c=i.event_data.properties[p],_=t[a](c,o);r&&_&&(u=!0,l=!1),s&&!_&&(u=!1,l=!1)}),u});e.isArray(o)&&o.length>0?(this.checkWindowAndMatch(o),n("--\u5c5e\u6027\u5339\u914d-\u6ee1\u8db3",o)):n("--\u5c5e\u6027\u5339\u914d-\u4e0d\u6ee1\u8db3")},t.RuleCheck.prototype.checkWindowAndMatch=function(i){var o=this,a=[];e.each(i,function(i){if(!i.params||!i.params[0])return n("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u89c4\u5219\u6570\u636e\u5f02\u5e38"),!1;var r=Number(i.params[0]);1===r?a.push(i):r>1&&e.isObject(i.window)&&i.window.value>0&&(!e.isObject(i.is_in_window)||!e.isNumber(i.is_in_window.expire_time)||i.is_in_window.expire_time<o.current_time?i.is_in_window={expire_time:t.ruleTime.getExpire(i.window,o.current_time),count:1}:i.is_in_window.count=i.is_in_window.count+1,i.is_in_window.count>=r?a.push(i):n("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u89c4\u5219\u6570",i.is_in_window.count,"\u4e0d\u5339\u914d\u5f53\u524d\u6b21\u6570",r))}),a.length>0?(n("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u6709\u5339\u914d\u6210\u529f\u7684\u89c4\u5219",a),this.checkGlobalPopupLimit()):n("--\u7a97\u53e3\u671f\u548c\u6b21\u6570-\u6ca1\u6709\u5339\u914d\u6210\u529f\u7684\u89c4\u5219",a)},t.RuleCheck.prototype.checkGlobalPopupLimit=function(){var i=t.localData.msg_limit_global,o=!0,a=this;e.isObject(i)&&i.is_in_use===!0&&e.isArray(i.limits)&&e.isArray(t.localData.global_popup_count)&&this.plan.global_msg_limit_enabled===!0?(e.each(i.limits,function(i){if(e.isObject(i)&&e.isNumber(i.limit)){var r=t.ruleTime.getLast(i,a.current_time),s=t.ruleTime.getArrMatchCount(t.localData.global_popup_count,r);n("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u5df2\u7ecf\u5f39\u7a97\u6b21\u6570-"+s+"-\u9650\u5236\u7684\u6b21\u6570"+i.limit+"-\u9650\u5236\u65f6\u95f4-"+r),o=s<i.limit?o&&!0:o&&!1}}),o?this.checkPopupLimit():n("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u4e0d\u6ee1\u8db3")):(n("--\u5168\u5c40\u5f39\u7a97\u9650\u5236-\u4e0d\u6ee1\u8db3(\u53c2\u6570\u6b63\u5e38\uff0c\u5df2\u5f39\u8fc7\u7a97\uff0c\u5f53\u524d\u8ba1\u5212\u8bbe\u7f6e\u4e86\u9650\u5236)\u4e4b\u4e00 - \u6ee1\u8db3"),this.checkPopupLimit())},t.RuleCheck.prototype.checkPopupLimit=function(){return e.isObject(this.plan.re_enter)&&e.isNumber(this.plan.re_enter.value)&&e.isNumber(this.plan.re_enter.limit)?void(e.isObject(this.plan.is_in_popup_limit_window)&&e.isNumber(this.plan.is_in_popup_limit_window.expire_time)&&e.isNumber(this.plan.is_in_popup_limit_window.count)?this.plan.is_in_popup_limit_window.expire_time<this.current_time?(n("--\u53c2\u4e0e\u9650\u5236-\u8d85\u8fc7\u4e86\u53c2\u4e0e\u9650\u5236\u7a97\u53e3-\u5f00\u542f\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),delete this.plan.is_in_popup_limit_window,this.plan_match.match_state=!0):this.plan.is_in_popup_limit_window.count<this.plan.re_enter.limit?(n("--\u53c2\u4e0e\u9650\u5236-\u5728\u7a97\u53e3\u5185\u4e14\u5728\u53c2\u4e0e\u9650\u5236\u6b21\u6570\u5185-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),this.plan_match.match_state=!0):n("--\u53c2\u4e0e\u9650\u5236-\u5728\u7a97\u53e3\u5185\u4f46\u662f\u8d85\u8fc7\u4e86\u53c2\u4e0e\u9650\u5236-\u4e0d\u6ee1\u8db3",this.plan.is_in_popup_limit_window):(this.plan.is_in_popup_limit_window?(n("--\u53c2\u4e0e\u9650\u5236-\u6709\u7a97\u53e3\u4f46\u662f\u7a97\u53e3\u6570\u636e\u5f02\u5e38-\u5f00\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),delete this.plan.is_in_popup_limit_window):n("--\u53c2\u4e0e\u9650\u5236-\u4e0d\u5b58\u5728\u7a97\u53e3-\u5f00\u65b0\u7a97\u53e3-\u6ee1\u8db3",this.plan.is_in_popup_limit_window),this.plan_match.match_state=!0)):(this.plan_match.match_state=!0,!1)},t.store={init:function(){t.localData=this.getJSONData()||{global_popup_count:[],local_update_time:null,eventQueue:[]},e.isNumber(t.localData.config_pull_interval_ms)&&t.localData.config_pull_interval_ms>0&&(t.updateDataAndSetListen.interval_time=t.localData.config_pull_interval_ms),t.log("\u521d\u59cb\u5316-\u83b7\u53d6-\u5185\u5b58-localData")},getJSONData:function(){return e.localStorage.parse(t.config.storageName)},saveJSONData:function(){e.localStorage.set(t.config.storageName,JSON.stringify(t.localData))}},t.updateDataAndSetListen={active_state:!0,interval_time:6e5,save_interval:null,data_interval:null,image_list:null,filterConvertPlans:function(){var n=t.localData.popup_plans;if(!n||!e.isArray(n))return!1;var i=e.filter(n,function(t){return!!t.convert_window&&!!t.is_in_convert_window;
});t.convertPlans=i,t.log("\u521d\u59cb\u5316-\u5f02\u6b65\u7684convertWindow",t.convertPlans),t.asyncConvert()},diffData:function(){var n=t.localData,i=JSON.parse(JSON.stringify(t.serverData)),o=(new Date).getTime();if(!i||e.isEmptyObject(i))return!1;var a=o-i.server_current_time;if(Math.abs(a)>=6e5)return!1;if(!n||e.isEmptyObject(n)||!n.popup_plans||0===n.popup_plans.length)return e.extend(t.localData,i),!1;var r=i.popup_plans;e.each(r,function(i,o){var a=null;if(e.each(n.popup_plans,function(n){n.plan_id===i.plan_id&&(a=n,i.audience_id||delete a.audience_id,e.isObject(i.window_update)&&e.each(i.window_update,function(e,n){a.window_update&&a.window_update[n]===e||("trigger_window"===n?a.pattern_popup.matcher_list=i.pattern_popup.matcher_list:"convert_window"===n&&a.is_in_convert_window&&i.convert_window&&a.is_in_convert_window.start_time&&(a.is_in_convert_window.expire_time=t.ruleTime.getExpire(i.convert_window,a.is_in_convert_window.start_time)))}))}),!a)return!1;if(!i.window_update&&a.last_update_config_time!==i.last_update_config_time)return!1;var s=a.pattern_popup.matcher_list;e.extend2Lev(a,i),a.pattern_popup.matcher_list=s,r[o]=a}),e.extend(t.localData,i),t.log("\u521d\u59cb\u5316-\u6bd4\u5bf9\u6570\u636e\u5f97\u5230\u9700\u8981\u7684-localData",t.localData)},getEventRule:function(){var n=t.localData.popup_plans,i={};return!(!n||!e.isArray(n))&&(e.each(n,function(t){var n=t.pattern_popup.matcher_list;e.each(n,function(n){var o={plan:t,rule:[n]},a=n.event_name,r=!1;if(i[a]){if(e.each(i[a],function(e){e.plan.plan_id===t.plan_id&&(e.rule.push(n),r=!0)}),r)return!1;i[a].push(o)}else i[a]=[o]})}),e.each(i,function(t){t.sort(function(t,e){var n=e.plan.absolute_priority-t.plan.absolute_priority;return 0===n?e.plan.plan_id-t.plan.plan_id:n})}),t.eventRule=i,t.log("\u521d\u59cb\u5316-\u5f97\u5230\u4e8b\u4ef6\u548c\u8ba1\u5212\u7684\u5173\u7cfb"),void t.log("--------------------\u521d\u59cb\u5316\u5b8c\u6210--------------------\u7b49\u5f85\u4e8b\u4ef6\u89e6\u53d1\u8ba1\u5212--------------------"))},registerListen:function(){var n=this;t.sa.events.on("send",function(n){n.event&&t.eventRule[n.event]&&(e.isArray(t.localData.eventQueue)||(t.localData.eventQueue=[]),t.localData.eventQueue.push(n),t.eventTriggerProcess())}),t.sa.events.on("changeDistinctId",function(t){n.changeId()}),t.sa.events.isReady()},setListenEvent:function(){this.diffData(),this.filterConvertPlans(),this.getEventRule()},loadImage:function(t){function e(t){var e=new Image;e.src=t}if(t.length<1)return!1;if(JSON.stringify(t)===JSON.stringify(this.image_list))return!1;this.image_list=t;for(var n=0;n<t.length;n++)e(t[n])},getDataFromServer:function(n,i){var o=this,a=encodeURIComponent(t.sa.store.getDistinctId()),r=encodeURIComponent(t.info.platform),s=encodeURIComponent(t.info.project);n=e.isFunction(n)?n:function(){},i=e.isFunction(i)?i:function(){},e.ajax({url:t.info.api_base_url+"/sfo/user_popup_configs?distinct_id="+a+"&platform="+r+"&project="+s+"&time="+(new Date).getTime()+"&sdk_version="+t.lib_version,type:"GET",cors:!0,credentials:!1,contentType:"application/json",success:function(a){return o.active_state?(t.log("\u521d\u59cb\u5316-\u4fee\u6539-serverData-ajax\u83b7\u53d6"),e.isObject(a)&&a.server_current_time&&a.popup_plans&&/\d+\.\d+/.test(a.min_sdk_version_required)&&parseFloat(a.min_sdk_version_required)<=parseFloat(t.lib_version)?(t.serverData=a,e.isNumber(a.config_pull_interval_ms)&&a.config_pull_interval_ms>0&&(o.interval_time=a.config_pull_interval_ms),t.localData.local_update_time=(new Date).getTime(),o.loadImage(t.getImageList(a.popup_plans)),o.setListenEvent()):(t.log("\u521d\u59cb\u5316-\u6570\u636e\u5f02\u5e38-\u8bf7\u6c42\u8fd4\u56de\u7684\u6570\u636e\u9519\u8bef-\u4e2d\u6b62"),t.serverData={},t.localData={}),n(),void o.setIntervalTime(o.interval_time)):(i(),!1)},error:function(){return o.active_state?(t.log("\u521d\u59cb\u5316-\u6570\u636e\u5f02\u5e38-\u8bf7\u6c42\u9519\u8bef-\u4e2d\u6b62"),t.serverData={},n(),void o.setIntervalTime(o.interval_time)):(i(),!1)}})},setIntervalTime:function(e){var n=this;this.data_interval=setTimeout(function(){t.log("10\u5206\u949f\u5b9a\u65f6\u66f4\u65b0\u6570\u636e\u5f00\u59cb-------"),n.getDataFromServer()},e)},setFirstListen:function(){var t=this;this.getDataFromServer(function(){t.registerListen()})},updateLocalData:function(){var e=JSON.stringify(t.localData);this.save_interval=setInterval(function(){var n=JSON.stringify(t.localData);e!==n&&(t.store.saveJSONData(),e=n)},500)},initial:function(){t.store.init(),this.updateLocalData();var n=t.localData.local_update_time,i=(new Date).getTime();if(e.isNumber(n)){var o=i-n;o<=0||o>=this.interval_time?this.setFirstListen():(this.setIntervalTime(this.interval_time-o),this.setListenEvent(),this.registerListen(),this.loadImage(t.getImageList(t.localData.popup_plans)))}else this.setFirstListen()},changeId:function(){this.stopAllState(),this.startState({getLocalData:!1})},stopAllState:function(){this.active_state=!1,t.eventRule={},this.data_interval&&window.clearTimeout(this.data_interval),this.save_interval&&window.clearInterval(this.save_interval),t.asyncConvert.timer&&window.clearTimeout(t.asyncConvert.timer),t.convertPlans=[],t.log("\u521d\u59cb\u5316-\u6e05\u7a7a-localData"),t.localData={},this.resetState()},resetState:function(e){return"WEB"!==t.info.platform&&void(!document.querySelector("div[data-sf-mask]")&&t.isRun&&(t.isRun=!1))},startState:function(e){this.active_state=!0,e=e||{getLocalData:!0};var n=this;e.getLocalData&&(this.resetState(),t.store.init()),this.getDataFromServer(function(){t.store.saveJSONData(),n.updateLocalData()})}},t.testSend={hasParam:function(){var t=e.URL(window.location.href).searchParams,n=t.get("sf_popup_test")||"",i=t.get("popup_window_id")||"",o=t.get("platform");return!(!n||!i)&&{sf_popup_test:n,popup_window_id:i,platform:o}},start:function(){var e=this.hasParam().platform;return"WEB"!==e?(t.log("H5\u6d4b\u8bd5\u5f39\u7a97\u8bf7\u5728\u79fb\u52a8\u7aef\u67e5\u770b\uff01"),!1):void this.webCampaign()},webCampaign:function(){var n=t.info.project,i=t.info.platform,o=this.hasParam().popup_window_id,a=encodeURIComponent(t.sa.store.getDistinctId());e.ajax({url:t.info.api_base_url+"/sfo/popup_windows/"+o+"?project="+encodeURIComponent(n)+"&time="+(new Date).getTime()+"&sdk_version="+t.lib_version+"&platform="+encodeURIComponent(i)+"&distinct_id="+a,type:"GET",credentials:!1,cors:!0,contentType:"application/json",success:function(n){var i,o=e.getUuid();e.isObject(n)||(t.sa.log("\u6d4b\u8bd5\u5f39\u7a97-\u670d\u52a1\u7aef\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5",n),n={});try{i=JSON.parse(n.content)}catch(a){t.sa.log("\u6d4b\u8bd5\u5f39\u7a97-content\u89e3\u6790\u5931\u8d25,content:",n,a)}var r=t.getPopupInfo(i);r.$sf_msg_id=o;var s={content:n.content,type:n.popup_type||"CUSTOMIZED"};e.isString(n.content)?"withoutCampaignListener"===t.info.supportCustom||"withoutStart"===t.info.supportCustom?(r.$sf_succeed=!1,r.$sf_fail_reason="\u81ea\u5b9a\u4e49\u89e6\u8fbe\u8ba1\u5212\u672a\u5b9e\u73b0\u5f39\u7a97\u751f\u547d\u5468\u671f\u56de\u8c03",t.track.popupDisplay(r),t.info.popup_campaign_listener.onFailed(s,1006,"\u81ea\u5b9a\u4e49\u89e6\u8fbe\u8ba1\u5212\u672a\u5b9e\u73b0\u5f39\u7a97\u751f\u547d\u5468\u671f\u56de\u8c03")):(r.$sf_succeed=!0,t.track.popupDisplay(r),t.info.popup_campaign_listener.onStart(s)):(r.$sf_succeed=!1,r.$sf_fail_reason="\u9884\u89c8\u4fe1\u606f\u89e3\u6790\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u8ba1\u5212\u914d\u7f6e",t.track.popupDisplay(r),t.info.popup_campaign_listener.onFailed(s,1001,"\u9884\u89c8\u4fe1\u606f\u89e3\u6790\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u8ba1\u5212\u914d\u7f6e"))},error:function(e){t.log("\u6d4b\u8bd5\u5f39\u7a97\u83b7\u53d6\u6570\u636e\u9519\u8bef",e)}})}},t.setPara=function(n){e.isObject(n)||(n={}),t.info=e.extend({},t.defaultPara,n),t.sa=t.getWebSDK();var i=t.sa;return i?e.isString(t.info.api_base_url)&&"http"===t.info.api_base_url.slice(0,4)?"http:"===t.info.api_base_url.slice(0,5)&&"https:"===location.protocol?(t.log("\u60a8\u7684\u5f53\u524d\u9875\u9762\u662fhttps\u7684\u5730\u5740\uff0capi_base_url \u4e5f\u5fc5\u987b\u662fhttps\uff01"),!1):(t.info.api_base_url="/"===t.info.api_base_url.slice(-1)?t.info.api_base_url.slice(0,-1):t.info.api_base_url,e.isString(i.para.server_url)&&"http"===i.para.server_url.slice(0,4)?(t.info.project||(t.info.project=e.URL(i.para.server_url).searchParams.get("project")||"default"),t.info.supportCustom=!0,e.isObject(t.info.popup_campaign_listener)?(e.isFunction(t.info.popup_campaign_listener.shouldStart)||(t.info.popup_campaign_listener.shouldStart=function(){return!0}),e.isFunction(t.info.popup_campaign_listener.onStart)||(t.info.supportCustom="withoutStart",t.info.popup_campaign_listener.onStart=function(){}),e.isFunction(t.info.popup_campaign_listener.onEnd)||(t.info.popup_campaign_listener.onEnd=function(){}),e.isFunction(t.info.popup_campaign_listener.onFailed)||(t.info.popup_campaign_listener.onFailed=function(){})):(t.info.supportCustom="withoutCampaignListener",t.info.popup_campaign_listener={shouldStart:function(){return!0},onStart:function(){},onEnd:function(){},onFailed:function(){}}),!0):(t.log("server_url \u5fc5\u987b\u586b\u5199\u6709\u6548\u6570\u636e\u63a5\u6536\u5730\u5740"),!1)):(t.log("popup \u5fc5\u987b\u586b\u5199\u6709\u6548 api_base_url"),!1):(t.log("web js sdk \u8fd8\u6ca1\u6709\u521d\u59cb\u5316\u5b8c\u6210"),!1)},t.init=function(){if(!t.isSupportPopup())return!1;if(window.screen.width&&Number(window.screen.width)<=1024)return"object"==typeof console&&console.log&&console.log("Web \u5f39\u7a97\u4ec5\u652f\u6301 PC\u7aef\uff0c\u4e14\u5c4f\u5e55\u5bbd\u5ea6\u5927\u4e8e 1024"),!1;var n={};return arguments.length>0&&(1===arguments.length&&e.isObject(arguments[0])?n=arguments[0]:arguments.length>=2&&e.isObject(arguments[1])&&(n=arguments[1])),!!this.setPara(n)&&(t.info.platform="WEB",!!t.setIsLoad()&&void(t.testSend.hasParam()?t.testSend.start():(t.listenPageStateChange(),t.updateDataAndSetListen.initial())))},window.SensorsDataWebJSSDKPlugin&&"[object Object]"===Object.prototype.toString.call(window.SensorsDataWebJSSDKPlugin)?window.SensorsDataWebJSSDKPlugin.WebPopup=window.SensorsDataWebJSSDKPlugin.WebPopup||t:window.SensorsDataWebJSSDKPlugin={WebPopup:t},t});